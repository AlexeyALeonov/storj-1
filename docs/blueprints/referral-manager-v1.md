# Referral Manager V1: Cross-Satellite Referral Link

## Abstract

This document describes how to handle referrals across satellites.

## Background

Current referral program only works per satellite, meaning a user on us-east-1 satellite can only refer people to join us-east-1.
For consistent experience we need to be able to handle cross-satellite referrals.

For a better user experience we also need to have a sign-up page where user can select Satellite during registration which is not in the scope of this blueprint.

## Design

### Definitions

Referral Manager
: A stand-alone process running outside of satellites. It should only talk to tardigrade branded satellites.

Referral Manager CLI
: A CLI that will allow operators (maybe there's a better to word this?) to invoke referral link generation.

Referral Link
: A one-time-use URL that contains a unique invitation token.

Invitation Token
: An random number generated by Referral Manager for each user to be able to participate in our referral program.

### How it will work

_Referral Link Generation_

1. Marketing team distributes new referral links through Referral Manager CLI, which asks tardigrade satellites for userIDs.
2. Satellite receives user infos request, which:
    - starts gathering of users whose current count of remaining invitation token is 0.
3. Satellite finishes gathering userIDs and send it back to Referral Manager.
4. Referral manager generates x amount of invitation tokens per user based on the input from CLI.
6. Referral manager adds the newly generated invitation tokens and the users each token associated with into Referral Manager database.
7. Referral manager sends back the invitation token along with the owner IDs back to corresponding satellites.
8. Satellite stores the invitation tokens into users table so it can display them in satellite GUI

_Referral Link Redemption_

1. User Alice tries to register a new account through a referral link, which triggers satellite to verify invitation token using Referral manager.
2. Referral Manager checks the status of the token:
    - if it is not redeemed, Referral Manager sends back a success response to the satellite and mark the token as redeems in the Referral Manager's database
    - if it token is already redeemed, Referral Manager sends back a invalid token response to the satellite.
3. Satellite receives the response, which:
    - if it is a success, the satellite will proceed with the account creation, remove the used token from users table, and
    also send a request to the Referral Manager to save the newly created user ID along with the used token.
    - if it is a invalid token, the satellite will display a proper message in the UI.
    
_Referral Manager CLI_

1. `referral manager start` will start the invitation token generation process and send a request to tardigrade satellites for users whose current count of remaining invitation token is 0.
2. After receiving responses from all satellites, the CLI should then display the total amount of users from the responses. 
3. The CLI should then prompt `How many invitation do you want to generate for each user?`
4. After getting an integer input, the CLI should ask for an confirmation `Generating X amount of invitation tokens for X amount of users. Yes/No.`
5. If the input is `Yes`, it will follow the `Referral Link Generation` process.
6. If the input is `No`, it should exit.

## Implementation


## Wrapup

[Who will archive the blueprint when completed? What documentation needs to be updated to preserve the relevant information from the blueprint?]

## Open issues
1. The existing token is implemented with 32 random bytes.
     - Is it safe to use across satellites?
     - If not, what should we use instead?
