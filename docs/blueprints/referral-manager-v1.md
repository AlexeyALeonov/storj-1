# Referral Manager V1: Cross-Satellite Referral Link

## Abstract

This document describes how to handle user referrals across satellites.

## Background

Previous referral program only works per satellite. This means a user on us-east-1 satellite can only refer people to join us-east-1.

We want referrals to be valid on all Tardigrade satellites. This will allow the user to select the satellite that is best for them.

### Non-Goals
A registration page where a user can select their preferred Satellite during registration.

## Design

### Definitions

Referral Manager
: A stand-alone process running outside of satellites. It should only talk to tardigrade branded satellites.

Referral Manager CLI
: A CLI that will allow operators to invoke referral link generation.

Referral Link
: A one-time-use URL that contains a unique invitation token.

Invitation Token
: A random number generated by Referral Manager for each user in the referral program.

Host Satellite
: The satellite that a particular token is stored on before it is redeemed.

Redeemed Satellite
: The satellite where the new user redeeming a token has registered on.

### How it will work

_Referral Manager CLI_

1. `referral manager start` initiates the invitation token generation process. This process begins by checking whether there are existing `eligibleUsers` in memory in Referral Manager.
    - If `eligibleUsers` is empty, the Referral Manager contacts Tardigrade satellites to get users with 0 remaining invites.
    - If `eligibleUsers` is not empty, it means one of two things:
        * Someone else is using the Referral Manager at the same time and has not generated/sent tokens yet.
        * The CLI was terminated between the get `eligibleUsers` step and the generate/send tokens step.
    
        Either one of the cases, We will return an error and display `Looks like there are existing selected users. By continuing the process, you will override the existing process. Do you still want to proceed? Yes/No.`. If they decide to continue, we call `ClearUsers` to sets eligibleUsers to empty and the Referral Manager contacts Tardigrade satellites to get users with 0 remaining invites.
3. The Referral Manager aggregates the satellite responses and returns the number of users to the CLI.
4. The CLI receives the number of users and displays: `How many invitation do you want to generate for each user?`
5. After the user enters the number of invites to generate, the CLI displays: `Generating X amount of invitation tokens for Y amount of users. Yes/No.`
   - If the input is `Yes`, it will follow the _Referral Link Distribution_ process below.
   - The CLI should exit if the input is `No`.

_Referral Link Distribution_

1. Marketing team distributes new referral links through Referral Manager CLI.
2. Referral Manager receives all userIDs from satellites and then generates x amount of invitation tokens per user based on the input from CLI.
3. Referral Manager adds the newly generated invitation tokens and the users each token associated with into Referral Manager database.
4. After storing tokens into the database, Referral Manager sends invitation tokens along with the owner IDs back to corresponding host satellites.
5. Host satellite receives the data and then stores the invitation tokens into `registration_token` table so they can be displayed on the satellite GUI.
6. Host satellite calls `ClearUsers` endpoint on the Referral Manager to set its users in `eligibleUsers` to empty.

_Referral Link Redemption_

1. User Alice tries to register a new account through a referral link, which triggers redeemed satellite to verify invitation token using Referral manager.
2. Referral Manager checks the status of the token:
    - if it is not redeemed, Referral Manager sends back a success response to the redeemed satellite and mark the token as redeemed in the Referral Manager's database
    - if it token is already redeemed, Referral Manager sends back a `invalid token` response to the redeemed satellite.
3. Redeemed satellite receives the response, which:
    - if it is a success, the satellite will proceed with the account creation and
    then send a request to the Referral Manager to save the newly created user ID along with the used token.
    - if it is an invalid token, the satellite will display a proper message in the UI.
4. Referral Manager reaches out to the host satellite holding the redeemed token, so that it can be removed from the UI.
    
_User Interface For Displaying Referral Link_

1. Users will have a referral tab on the UI. On click, it will try to retrieve referral tokens from the backend:
    - if the front-end receives tokens, it should display them.
    - if the front-end receives empty response payload, it should display a message `No available referral link. Try again later.`

## Rationale

We could add a new column `referral_tokens` in `users` table to store user's unredeemed tokens, since the `registration_token` is a temporary table.

## Implementation

- Create a private repository for Referral Manager.
- Create `tokens` and `satellites` table in Referral Manager database.
- Create a `Delete` method for satellite `registration_tokendb`.
- Implementing an endpoint on satellite for gathering users whose current count of remaining invitation token is 0.
- Implementing an endpoint on Referral Manager for setting in-memory `eligibleUsers` to be empty.
- Implementing generating invitation tokens from Referral Manager CLI.
- Implementing an endpoint on satellite for saving new referral links into users table.
- Implementing an endpoint on Referral Manager for verifying invitation tokens.
- Replace existing registration token logic.

Pseudocode

The Token struct represents both a Go struct (on satellite and Referral Manager) as well as the schema for the `tokens` table on the Referral Manager

```
type Token struct {
	Secret [32]byte
	OwnerID uuid.UUID
	RedeemedBy uuid.UUID
	HostSatelliteURL string
    RedeemedSatelliteURL string
	Status string
}
```
Statuses: `unsent` (host satellite doesn't know about it yet), `unredeemed` (host satellite knows about it but it has not been used), `redeemed` (someone has used this referral link to register alreadys)

Referral Manager endpoints:
```
// GetEligibleUsers retrieves a list of users who have 0 remaining invitation tokens
// from each satellite provided, and saves those users in memory
GetEligibleUsers([]satelliteURLs) (map[satelliteURL]int, error) {
    if referralManager.eligibleUser != nil {
        return nil, err
    }

    eligibleUsers := make(map[satelliteURL][]UserID)
    eligibleUsersCounts := make(map[satelliteURL]int)
    for _, satellite := range satelliteURL {
       users := satellite.GetUsersReferral() 
        eligibleUsers[satellite] = users
        eligibleUsersCounts[satellite]++
    }
    referralManager.eligibleUsers = eligibleUsers
    return eligibleUsersCounts, nil
}

// SendInvitationTokens generates tokens, saves those in the referral manager db
// and then sends newly created tokens to each respective satellite
GenerateAndSendInvitationTokens([]satelliteURL, tokensPerUser int) map[satelliteURL]int {
    eligibleUsers := referralManager.eligibleUsers
    if eligibleUsers == nil {
        return Error.New("No users to generate tokens for. Make sure to run GetEligibleUsers first")
    }
    var tokens []Token
    for satellite, users := range eligibleUsers {
        for _, user := range users {
            for i:=0; i<tokensPerUser; i++ {
                newToken := Token{data: generateRandomToken(), user: user, satellite: satellite}
                db.CreateToken(newToken)
                tokens = append(tokens, newToken)
            }
        }
    }

    results := make(map[satelliteURL]int)
    for _, satellite := range satelliteURLs {
        successCount := satellite.AddInvitationTokens(tokens)
        results[satellite] = successCount
    }
    return results
}

// Redeem marks a token as redeemed and deletes the token from host satellite
func Redeem(ctx, token, newUserID) error {
	// only update the status and invitee columns 
	// if the status of a token is unredeems
	tokenStatus, err := db.UpdateToken(ctx, token, newUserID, "redeemed")
	if err != nil {
		return err
	}

    token.HostSatelliteURL.DeleteInvitationToken(token)
}

// ClearUsers sets eligibleUsers to be empty
func ClearUsers(ctx, satelliteURL) error {
    if _, ok := referralManager.eligibleUsers[satelliteURL]; !ok {
        return err
    }

    referralManager.eligibleUsers[satelliteURL] = nil
    return nil
}
```

New satellite endpoints:
```
// GetUsersReferral gets a list of users on this satellite who have 0 remaining invitation tokens
GetUsersReferral() []userIDs {
    return db.GetUsersWhere0RemainingInvitationTokens()
}

// AddInvitationTokens associates a list of tokens from the referral manager with users on the satellite
// It returns the number of tokens added
AddInvitationTokens([]token) int {
    successCount := 0
    for token := range tokens {
        db.AddToken(token.user, token.data)
        successCount++
    }
    return successCount
}

// DeleteInvitationToken deletes a token on a satellite because it has been redeemed
DeleteInvitationToken(token Token) {
    db.DeleteToken(token.OwnerID
}
```

## Wrapup

Team Green will be responsible implementing this blueprint.

## Open issues
1. The existing token is implemented with 32 random bytes.
     - Is it safe to use across satellites?
     - If not, what should we use instead?
2. How do we deal with authentication/permission between the referral manager and satellites?
     - We only want the referral manager to be able to use the new endpoints on the satellite. How do we do this?
3. How do we deal with authentication/permission between the referral mangaer cli and the referral manager server?
4. Where should the user interface on the satellite GUI be?