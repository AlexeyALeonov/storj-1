
# Title: Referral Manager

## Abstract

Right now, referral program only works per satellite meaning a user on us-east-1 satellite can only refer people to join us-east-1. 
However, it's crucial for the tardigrade branded satellites to be able to handle cross-satellite referrals. Therefore, we plan to have a party in the network along with tardigrade satellites to handle this issue.

## Background

Along with cross-satellite referrals, we are also working on having a sign-up page that will allow users to select which satellite
they would like to register an account with. Below design is built based on the new sign-up flow.

## Design

####Definition
*Referral Link* - _A static link that contains a unique referral code_

*Referral Code* - _An uuid generated by referral manager program for each user to be able to participate in our referral program_

#### User Flow
1. Sign up

    After new user Alice chose to register on satellite B and clicked on the create account button:
    - Satellite B sends a request with its satellite id to referral manager for a referral code for Alice
    - Referral manager receives the request from satellite B, generates an unique referral code 11111111, and then store that code, 11111111, along with the satellite B's address into referral manager's database 
    - After successfully storing the referral code and satellite B's address, referral manager sends a response with the generated referral code, 11111111, back to satellite B 
    - Satellite B receives the referral code, 11111111, from referral manager and then store it along with Alice's information into user table in satellitedb
        - Signed up WITHOUT referral link:
            - Satellite B will store Alice's credit into user_credit table with a null value in referred_by column
        - Signed up WITH referral link:
            - If user Bonnie from satellite C referred Alice with a referral link, https://C.tardigrade.io/signup/22222222
            - satellite B will store the referral code, 22222222, in user_credits table under referred_by column along with Alice's credits information.

2. Award referrer credits
    
    After user Alice has used up their free credits:
    
    - Satellite B will send a request with the referral code, 22222222, to referral manager
    - Referral manager receives the request from satellite B and use the referral code, 22222222, to look up the satellite address that's associated with the referral code, 22222222, in its database
        - If no referral code can be found in referral manager's database that's equal to 22222222
            - referral manager sends back an INVALID response to satellite B
        
        - If a satellite address, C, is found through the referral code 22222222
            - referral manager sends the referral code 22222222 to satellite C
            - referral manager sends back a OK response to satellite B
            - satellite C receives the referral code 22222222
            - satellite C looks up the user Bonnie that's associated with the referral code 22222222
            - satellite C injects a new entry into user_credits table for Bonnie for their earned referrer credits
            
## Rationale
1. Will this overload satellites?

## Implementation

#### node id authentication 
_to make sure that the node id the referral manager is talking to is one of our approved satellites_

````golang
var approvedSatellites  map[storj.NodeID]satelliteAddress
var mu sync.RWMutex
func VerifySatelliteID(ctx context.Context, id storj.NodeID) (err error) {
	if approvedSatellites {
		return nil
	}

	mu.RLock()
	defer mu.RUnlock()

	_, ok := approvedSatellites[id]
	if !ok {
		return fmt.Errorf("satellite %q is unapproved", id)
	}
	return nil
}
````


#### Referral Manager grpc Definition
````grpc
package referralmanager;

import "gogo.proto";

service ReferralManager {
    rpc Request(ReferralCodeRequest) returns (ReferralCodeResponse) {}
    rpc Inform(InformReferrerRequest) returns (InformReferrerResponse) {}
}

message ReferralCode {
    bytes satellite_id = 1 [(gogoproto.customtype) = "NodeID", (gogoproto.nullable) = false];
    string referral_code = 2;
}

message Offer{
    int credit
    google.protobuf.Timestamp expiration_date = 1 [(gogoproto.stdtime) = true, (gogoproto.nullable) = false];
}

message ReferralCodeRequest {
    bytes satellite_id = 1 [(gogoproto.customtype) = "NodeID", (gogoproto.nullable) = false];
    string user_id = 2;
}

message ReferralCodeResponse {
    enum Status {
        INVALID  = 0;
        SUCCESS = 1;
    }

    ReferralCode referral_code = 1;
    
    string user_id = 2;
    Offer offer = 3;

    Status status = 4;
}

message InformReferrerRequest {
    ReferralCode referral_code = 1;
}

message InformReferrerResponse {
    enum Status {
        INVALID = 0;
        SUCCESS = 1;
    }
    
    Status status = 1;
}
````

#### Satellite grpc Endpoint Definition
````grpc
package referral

service Referral {
    rpc Update(ReferralRequest) returns (ReferralResponse) {}
}

message Offer{
    int credit
    google.protobuf.Timestamp expiration_date = 1 [(gogoproto.stdtime) = true, (gogoproto.nullable) = false];
}

message ReferralRequest {
    strings referral_code = 1;
    strings user_id = 2;
    
    Offer offer = 3;
    
}

message ReferralResponse {
    enum Status {
        INVALID = 0;
        SUCCESS = 1;
    }
    
    Status status = 1;
}
````

#### Referral Manager DB Design
1. table referral_codes
````sql
    referral_code blob PRIMARY KEY 
    satellite_id blob
````

2. table satellite_info
````sql
    satellite_id blob PRIMARY KEY 
    satellite_address text
````

3. table offers
````sql
    key id

	field id	serial
	field name text ( updatable )
	field description text ( updatable )

	field referrer_credit_in_cent int ( updatable, nullable )
	field invitee_credit_in_cent int ( updatable )

	field referrer_credit_duration_days int ( updatable, nullable )
	field invitee_credit_duration_days int ( updatable )

	field redeemable_cap int ( updatable, nullable )

	field expires_at timestamp ( updatable, nullable )
	field created_at timestamp ( autoinsert )

	// status has three possible value: NoStatus=0, Default=1, Active=2.
	field status int ( updatable )
	// type has two possible value: FREE_CREDIT=0, REFERRAL=1
	field type int ( updatable )
````

## Open issues (if applicable)
